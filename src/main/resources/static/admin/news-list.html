<meta charset="UTF-8">
<title>新闻管理</title>
<style>
    table {
           width: 100%;
           border-collapse: collapse;
       }
       th, td {
           border: 1px solid #ddd;
           padding: 8px;
           text-align: left;
       }
       th {
           background-color: #f2f2f2;
       }
       .content {
           display: none;
           margin-top: 10px;
           border: 1px solid #ddd;
           padding: 10px;
       }
       body {
           font-family: Arial, sans-serif;
           background-color: #f9f9f9;
           margin: 20px;
       }
       h1 {
           color: #333;
       }
       button {
           background-color: #4CAF50; /* Green */
           color: white;
           border: none;
           padding: 10px 15px;
           text-align: center;
           text-decoration: none;
           display: inline-block;
           font-size: 16px;
           margin: 4px 2px;
           cursor: pointer;
           border-radius: 5px;
           transition: background-color 0.3s;
       }
       button:hover {
           background-color: #45a049; /* Darker green */
       }
       table {
           margin-top: 20px;
       }
       #searchInput {
           padding: 10px;
           margin-right: 10px;
           border: 2px solid #D9534F; /* 更改为红色边框 */
           border-radius: 5px;
           background-color: #f9f9f9; /* 浅灰色背景 */
           width: 200px; /* 固定宽度 */
           transition: border-color 0.3s;
       }
       #searchInput:focus {
           border-color: #D9534F; /* 聚焦时的边框颜色更改为红色 */
           outline: none; /* 去掉默认的轮廓 */
       }
       .pagination {
           margin-top: 20px;
           display: flex;
           align-items: center;
           justify-content: center; /* 居中对齐 */
       }
       .pagination button {
           margin: 0 15px; /* 增加按钮之间的间距 */
           background-color: #D9534F; /* 更改为红色背景 */
           color: white; /* 白色文字 */
           border: none; /* 去掉边框 */
           border-radius: 5px;
           padding: 10px 15px;
           cursor: pointer; /* 鼠标指针 */
           transition: background-color 0.3s;
       }
       .pagination button:hover {
           background-color: #c9443e; /* 鼠标悬停时的颜色 */
       }
       .pagination input {
           width: 60px; /* 固定宽度 */
           padding: 8px;
           margin-left: 5px;
           border: 2px solid #D9534F; /* 绿色边框 */
           border-radius: 5px;
           text-align: center; /* 文本居中 */
       }
       .pagination input:focus {
           border-color: #D9534F; /* 聚焦时的边框颜色 */
           outline: none; /* 去掉默认的轮廓 */
       }
    .pagination {
        margin-top: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .pagination input[type="number"] {
        width: 60px;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .pagination input[type="number"]::-webkit-inner-spin-button,
    .pagination input[type="number"]::-webkit-outer-spin-button {
        opacity: 1;
    }

    .pagination button {
        padding: 5px 10px;
        background-color: #D9534F;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .pagination button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    .pagination span {
        margin: 0 5px;
    }
</style>
<script>
   
</script>
<div id="newsListContainer">
    <h1>所有新闻</h1>
    <div>
        <input type="text" placeholder="搜索新闻..." id="searchInput">
        <button style="background-color: #D9534F;" id="searchBtn">搜索</button>
    </div>

    <table>
        <thead>
        <tr>
            <th>标题</th>
            <th>作者</th>
            <th>提交审核的日期</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        <!-- 新闻列表将通过 JavaScript 动态填充 -->
        </tbody>
    </table>

    <div class="pagination">
        <button id="prevBtn">上一页</button>
        <span>当前页: <span id="currentPage">1</span></span>
        <span style="margin-left: 10px;">共 <span id="totalPages">0</span> 页</span>
        <button id="nextBtn">下一页</button>
        <input type="number"
               id="jumpPageInput"
               placeholder="跳转到页数"
               min="1"
               onkeypress="return event.charCode >= 48 && event.charCode <= 57"
               oninput="this.value = this.value.replace(/[^1-9]/g, ''); if(this.value > NewsListManager.totalPages) this.value = NewsListManager.totalPages;">
        <button id="jumpBtn">跳转</button>
    </div>

<script type="text/javascript">
    (function() {
        console.log('定义 NewsListManager');

        // 确保在全局作用域定义 NewsListManager
        window.NewsListManager = {
            currentPage: 1,
            pageSize: 5,
            totalPages: 1,
            initialized: false,

            init: function() {
                if (this.initialized) return;
                console.log('NewsListManager 初始化开始');
                this.initialized = true;
                this.bindEvents();
                this.fetchNewsList();
            },

            bindEvents: function() {
                console.log('绑定事件');

                // 使用箭头函数保持 this 的指向
                document.getElementById('searchBtn')?.addEventListener('click', () => this.searchNews());
                document.getElementById('prevBtn')?.addEventListener('click', () => this.prevPage());
                document.getElementById('nextBtn')?.addEventListener('click', () => this.nextPage());
                document.getElementById('jumpBtn')?.addEventListener('click', () => this.jumpToPage());
            },

            fetchNewsList: function() {
                console.log('开始获取新闻列表');
                const searchInput = document.getElementById('searchInput');

                const params = {
                    pageNum: this.currentPage,
                    pageSize: this.pageSize,
                    keyword: searchInput ? searchInput.value.trim() : ''
                };

                console.log('发送请求参数:', params);

                axios({
                    url: 'http://localhost:8080/news/list',
                    method: 'post',
                    data: params,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        console.log('获取新闻列表成功，原始响应:', response);
                        if (response.data.code === 200) {
                            const pageInfo = response.data.data;
                            console.log('分页数据:', pageInfo);

                            if (pageInfo && Array.isArray(pageInfo.list)) {
                                // 计算总页数
                                const total = pageInfo.list.length;
                                this.totalPages = Math.ceil(total / this.pageSize);

                                // 计算当前页的数据范围
                                const startIndex = (this.currentPage - 1) * this.pageSize;
                                const endIndex = Math.min(startIndex + this.pageSize, total);

                                // 只截取当前页需要显示的数据
                                const currentPageData = pageInfo.list.slice(startIndex, endIndex);

                                console.log(`总记录数: ${total}, 当前页: ${this.currentPage}, 总页数: ${this.totalPages}`);
                                console.log(`显示数据范围: ${startIndex} - ${endIndex}`);

                                this.renderNewsList(currentPageData);
                                this.updatePagination();
                            } else {
                                console.error('返回的数据格式不正确:', pageInfo);
                                this.handleEmptyData();
                            }
                        } else {
                            console.error('请求失败:', response.data.msg);
                            this.handleEmptyData();
                        }
                    })
                    .catch(error => {
                        console.error('获取新闻列表失败:', error);
                        this.handleEmptyData();
                    });
            },

            renderNewsList: function(newsList) {
                console.log('渲染新闻列表, 数据条数:', newsList.length);
                const tbody = document.querySelector('tbody');

                if (!newsList || newsList.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">暂无数据</td></tr>';
                    return;
                }

                tbody.innerHTML = newsList.map(news => `
        <tr>
            <td><h3>${news.title || '无标题'}</h3></td>
            <td>${news.username || '未知作者'}</td>
            <td>${news.date || '未知日期'}</td>
            <td>
                <button onclick="NewsListManager.deleteNews('${news.id}')">删除新闻</button>
                <button onclick="NewsListManager.viewDetails('${news.id}')">查看</button>
            </td>
        </tr>
    `).join('');
            },

            updatePagination: function() {
                console.log('更新分页信息');
                console.log(`当前页: ${this.currentPage}, 总页数: ${this.totalPages}`);

                // 更新当前页和总页数显示
                document.getElementById('currentPage').textContent = this.currentPage;
                document.getElementById('totalPages').textContent = this.totalPages;

                // 更新跳转输入框的限制
                const jumpPageInput = document.getElementById('jumpPageInput');
                jumpPageInput.max = this.totalPages;
                jumpPageInput.placeholder = `跳转到页数(1-${this.totalPages})`;

                // 更新按钮状态
                document.getElementById('prevBtn').disabled = this.currentPage <= 1;
                document.getElementById('nextBtn').disabled = this.currentPage >= this.totalPages;
            },

            // 添加导航方法
            prevPage: function() {
                console.log('尝试跳转到上一页');
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.fetchNewsList();
                }
            },

            nextPage: function() {
                console.log('尝试跳转到下一页');
                if (this.currentPage < this.totalPages) {
                    this.currentPage++;
                    this.fetchNewsList();
                }
            },

            jumpToPage: function() {
                console.log('尝试跳转到指定页');
                const jumpPageInput = document.getElementById('jumpPageInput');
                const pageNum = parseInt(jumpPageInput.value);

                if (!pageNum || pageNum < 1 || pageNum > this.totalPages) {
                    alert(`请输入有效的页码！(1-${this.totalPages})`);
                    jumpPageInput.value = '';
                    return;
                }

                this.currentPage = pageNum;
                this.fetchNewsList();
                jumpPageInput.value = '';
            },

            searchNews: function() {
                console.log('执行搜索');
                this.currentPage = 1; // 搜索时重置到第一页
                this.fetchNewsList();
            },

            deleteNews: function(newsId) {
                console.log('删除新闻:', newsId);
                if (!confirm('确定要删除这条新闻吗？')) return;

                axios({
                    url: `http://localhost:8080/news/delete`,
                    method: 'delete',
                    params: { id: newsId }
                })
                    .then(response => {
                        console.log('删除新闻响应:', response);
                        if (response.data.code === 200) {
                            alert('删除成功');
                            this.fetchNewsList(); // 重新加载列表
                        } else {
                            alert('删除失败：' + response.data.msg);
                        }
                    })
                    .catch(error => {
                        console.error('删除新闻失败:', error);
                        alert('删除失败：' + error.message);
                    });
            },

            viewDetails: function(newsId) {
                console.log('查看新闻详情:', newsId);
                axios({
                    url: `http://localhost:8080/news/select`,
                    method: 'get',
                    params: { id: newsId }
                })
                    .then(response => {
                        console.log('获取新闻详情响应:', response);
                        if (response.data.code === 200) {
                            const news = response.data.data;
                            this.showNewsModal(news);
                        } else {
                            alert('获取新闻详情失败：' + response.data.msg);
                        }
                    })
                    .catch(error => {
                        console.error('获取新闻详情失败:', error);
                        alert('获取详情失败：' + error.message);
                    });
            },

            showNewsModal: function(news) {
                console.log('显示新闻详情模态框');
                const modal = document.createElement('div');
                modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 5px;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
                z-index: 1000;
                max-width: 80%;
                max-height: 80vh;
                overflow-y: auto;
            `;

                modal.innerHTML = `
                <h2>${news.title}</h2>
                <p><strong>作者：</strong>${news.author}</p>
                <p><strong>提交日期：</strong>${news.submitDate}</p>
                <p><strong>内容：</strong></p>
                <div>${news.content}</div>
                <button onclick="this.parentElement.remove()" style="margin-top: 20px;">关闭</button>
            `;

                document.body.appendChild(modal);
            }
        };

        // 自动初始化
        console.log('等待 DOM 加载完成');
        setTimeout(() => {
            if (!window.NewsListManager.initialized) {
                console.log('执行自动初始化');
                window.NewsListManager.init();
            }
        }, 100);
    })();
</script>